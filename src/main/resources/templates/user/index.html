<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Users</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
	rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">
<!-- Favicon / Logo -->
<link rel="icon" type="image/png" href="/images/kr.png">
</head>
<body>
	<div class="d-flex">
		<!-- Sidebar -->
		<div th:replace="fragments/sidebar :: sidebar"></div>

		<!-- Main Content -->
		<div class="content p-4 flex-grow-1">
			<h1 class="text-center mb-4">
				<i class="bi bi-person-lines-fill me-2"></i>Users Listing
			</h1>

			<!-- Success/Error messages -->
			<div th:if="${successMessage}" class="alert alert-success"
				role="alert" th:text="${successMessage}"></div>
			<div th:if="${errorMessage}" class="alert alert-danger" role="alert"
				th:text="${errorMessage}"></div>

			<!-- Add User Button -->
			<button class="btn btn-primary mb-3" data-bs-toggle="modal"
				data-bs-target="#addUserModal">
				<i class="bi bi-plus-circle"></i> Add New User
			</button>

			<!-- Users Table -->
			<table class="table table-bordered text-center">
				<thead class="table-dark">
					<tr>
						<th>ID</th>
						<th>UserName</th>
						<th>Role</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="user : ${users}">
						<td th:text="${user.id}"></td>
						<td th:text="${user.username}"></td>
						<td th:text="${user.role}"></td>
						<td>
							<!-- Edit -->
							<button class="btn btn-warning btn-sm" data-bs-toggle="modal"
								data-bs-target="#editUserModal" th:attr="data-id=${user.id}">
								<i class="bi bi-pencil-square"></i> Edit
							</button> <!-- Delete -->
							<button class="btn btn-danger btn-sm" data-bs-toggle="modal"
								data-bs-target="#deleteModal"
								th:attr="data-id=${user.id}, data-name=${user.username}">
								<i class="bi bi-trash"></i> Delete
							</button>
						</td>
					</tr>
					<tr th:if="${#lists.isEmpty(users)}">
						<td colspan="4">No users found.</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Add User Modal -->
	<div class="modal fade" id="addUserModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 500px;">
			<!-- width-->
			<div class="modal-content" style="height: 60vh;">
				<!-- height  -->
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title text-center w-100">
						<i class="bi bi-person-plus-fill me-2"></i> Add User
					</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="addUserModalBody">
					<div class="text-center py-4">
						<div class="spinner-border text-primary"></div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Edit User Modal -->
	<div class="modal fade" id="editUserModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 500px;">
			<div class="modal-content" style="height: 60vh;">
				<div class="modal-header bg-warning text-white">
					<h5 class="modal-title text-center w-100">
						<i class="bi bi-pencil-square me-2"></i> Edit User
					</h5>

					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" id="editUserModalBody">
					<div class="text-center py-4">
						<div class="spinner-border text-warning"></div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Delete Confirmation Modal -->
	<div class="modal fade" id="deleteModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title">Confirm Delete</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body text-center">
					<p>Are you sure you want to delete this user?</p>
					<strong id="deleteUserName"></strong>
				</div>
				<div class="modal-footer">
					<form id="deleteForm" th:action="@{/sales/delete/}" method="post"
						class="w-100">
						<input type="hidden" name="_method" value="delete">
						<div class="row g-2">
							<div class="col">
								<button type="button" class="btn btn-secondary w-100"
									data-bs-dismiss="modal">
									<i class="bi bi-x-circle me-1"></i> Cancel
								</button>
							</div>
							<div class="col">
								<button type="submit" class="btn btn-danger w-100">
									<i class="bi bi-trash me-1"></i> Delete
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<!-- Add/Edit/Delete AJAX -->
	<script>
	document.addEventListener('DOMContentLoaded', function() {

    // ---- ADD User ----
    const addUserModal = document.getElementById('addUserModal');
    const addBody = document.getElementById('addUserModalBody');
    addUserModal.addEventListener('show.bs.modal', () => {
        fetch('/user/add-form')
            .then(res => res.text())
            .then(html => addBody.innerHTML = html)
            .catch(() => addBody.innerHTML = '<p class="text-danger text-center">Failed to load form.</p>');
    });
    addUserModal.addEventListener('hidden.bs.modal', () => {
        addBody.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>`;
    });

    // ---- EDIT User ----
    const editUserModal = document.getElementById('editUserModal');
	const editBody = document.getElementById('editUserModalBody');
	
	editUserModal.addEventListener('show.bs.modal', function(event) {
	    const id = event.relatedTarget.getAttribute('data-id');
	    fetch(`/user/edit-form/${id}`)
	        .then(res => res.text())
	        .then(html => editBody.innerHTML = html)
	        .catch(() => editBody.innerHTML = '<p class="text-danger text-center">Failed to load form.</p>');
	});
	
	editUserModal.addEventListener('hidden.bs.modal', () => {
	    editBody.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-warning"></div></div>`;
	});

    // ---- DELETE User ----
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const deleteUserName = document.getElementById('deleteUserName');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        deleteUserName.textContent = name;
        deleteForm.action = `/user/delete/${id}`;
    });

});
</script>
	<script>
// Auto-hide success/error messages after 3 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        }, 3000); // 3000ms = 3 seconds
    });
});
</script>

</body>
</html>
