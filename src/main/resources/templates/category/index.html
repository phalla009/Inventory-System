<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Categories Listing</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
	rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">

<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer&display=swap"
	rel="stylesheet">
<link rel="icon" type="image/png" href="/images/kr.png">
</head>

<body>
	<div class="d-flex bg-dark">

		<!-- Sidebar -->
		<div th:replace="fragments/sidebar :: sidebar"></div>
		<!-- Toast Messages -->
		<div class="content p-4">

			<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
				<div th:if="${successMessage}" class="toast text-bg-success show"
					role="alert" aria-live="assertive" aria-atomic="true">
					<div class="toast-body" th:text="${successMessage}"></div>
				</div>

				<div th:if="${errorMessage}" class="toast text-bg-danger show"
					role="alert" aria-live="assertive" aria-atomic="true">
					<div class="toast-body" th:text="${errorMessage}"></div>
				</div>
			</div>


			<!-- Main Content -->

			<h1 class="mb-3">
				<i class="bi bi-tags me-2"></i> Categories Listing
			</h1>

			<!-- Toast Messages -->
			<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;">
				<div th:if="${successMessage}" class="toast text-bg-success show">
					<div class="toast-body" th:text="${successMessage}"></div>
				</div>

				<div th:if="${errorMessage}" class="toast text-bg-danger show">
					<div class="toast-body" th:text="${errorMessage}"></div>
				</div>
			</div>

			<!-- Add Category -->
			<button class="btn btn-primary mb-3" data-bs-toggle="modal"
				data-bs-target="#addCategoryModal">
				<i class="bi bi-plus-circle me-1"></i> Add Category
			</button>

			<!-- Category Table -->
			<div style="max-height: 450px; overflow-y: auto;">
				<table class="table table-bordered table-hover align-middle">
					<thead class="table-dark sticky-top">
						<tr>
							<th>ID</th>
							<th>Category Name</th>
							<th>Status</th>
							<th>Created At</th>
							<th>Actions</th>
						</tr>
					</thead>

					<tbody style="font-family: 'Noto Sans Khmer', Arial, sans-serif;">
						<tr th:each="category : ${categories}">
							<td th:text="${category.id}"></td>
							<td th:text="${category.name}"></td>

							<td><span th:if="${category.status == 'Active'}"> <i
									class="bi bi-check-circle text-success"></i>
							</span> <span th:if="${category.status == 'Inactive'}"> <i
									class="bi bi-x-circle text-danger"></i>
							</span> <span th:text="${category.status}" class="ms-1"></span></td>

							<td
								th:text="${#temporals.format(category.createdAt, 'yyyy-MM-dd HH:mm')}"></td>

							<td>
								<button class="btn btn-warning btn-sm" data-bs-toggle="modal"
									data-bs-target="#editCategoryModal"
									th:attr="data-id=${category.id}">
									<i class="bi bi-pencil-square"></i>
								</button>

								<button class="btn btn-danger btn-sm" data-bs-toggle="modal"
									data-bs-target="#deleteModal"
									th:attr="data-id=${category.id}, data-name=${category.name}">
									<i class="bi bi-trash"></i>
								</button>
							</td>
						</tr>
						<tr th:if="${#lists.isEmpty(categories)}">
							<td colspan="5" class="text-center">No categories found.</td>
						</tr>

					</tbody>
				</table>
			</div>
		</div>
	</div>


	<!-- ================= MODALS ================= -->

	<!-- Add Category Modal -->
	<div class="modal fade" id="addCategoryModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">

				<div
					class="modal-header bg-primary text-white justify-content-center">
					<h5 class="modal-title text-center">
						<i class="bi bi-plus-circle"></i> Add Category
					</h5>
				</div>


				<div class="modal-body" id="addCategoryForm">
					<div class="text-center py-4">
						<div class="spinner-border text-primary"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Edit Category Modal -->
	<div class="modal fade" id="editCategoryModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-warning justify-content-center">
					<h5 class="modal-title">
						<i class="bi bi-pencil-square"></i> Edit Category
					</h5>
				</div>

				<div class="modal-body" id="editCategoryForm">
					<div class="text-center py-4">
						<div class="spinner-border text-primary"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Delete Modal -->
	<div class="modal fade" id="deleteModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title">
						<i class="bi bi-exclamation-triangle"></i> Confirm Delete
					</h5>
				</div>

				<div class="modal-body">
					Are you sure you want to delete: <strong id="deleteCategoryName"></strong>
					?
				</div>

				<div class="modal-footer">
					<form id="deleteForm" method="post" class="w-100">
						<input type="hidden" name="_method" value="delete">
						<div class="row g-2">
							<div class="col">
								<button type="button" class="btn btn-secondary w-100"
									data-bs-dismiss="modal">
									<i class="bi bi-x-circle me-1"></i> No, keep it
								</button>
							</div>
							<div class="col">
								<button type="submit" class="btn btn-danger w-100">
									<i class="bi bi-trash me-1"></i> Yes, Delete!
								</button>
							</div>
						</div>
					</form>
				</div>


			</div>
		</div>
	</div>

	<!-- ================= SCRIPTS ================= -->

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<!-- âœ… Auto-hide success message -->
	<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Select all visible toast elements
        const toasts = document.querySelectorAll('.toast.show');

        toasts.forEach(toastEl => {
            const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 }); // 3 seconds
            bsToast.show(); // show toast
        });
    });
</script>

	<script>
		document.getElementById('addCategoryModal').addEventListener('show.bs.modal', () => {
		    fetch('/categories/add')
		        .then(res => res.text())
		        .then(html => document.getElementById('addCategoryForm').innerHTML = html);
		});
		
		document.getElementById('editCategoryModal').addEventListener('show.bs.modal', e => {
		    const id = e.relatedTarget.getAttribute('data-id');
		    fetch(`/categories/edit/${id}`)
		        .then(res => res.text())
		        .then(html => document.getElementById('editCategoryForm').innerHTML = html);
		});
		
		document.getElementById('deleteModal').addEventListener('show.bs.modal', function(e) {
		    const button = e.relatedTarget;
		    const categoryId = button.getAttribute('data-id');       // get category id
		    const categoryName = button.getAttribute('data-name');   // get category name
		
		    document.getElementById('deleteCategoryName').textContent = categoryName;
		    document.getElementById('deleteForm').setAttribute('action', '/categories/delete/' + categoryId);
		});

</script>

</body>
</html>
